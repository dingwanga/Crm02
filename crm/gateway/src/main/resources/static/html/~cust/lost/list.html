<!DOCTYPE html>
<html lang="en">
<head>
    <title>客户流失管理</title>
    <meta charset="UTF-8">
    <link href="../../css/style.css" rel="stylesheet" type="text/css">
    <script src="../../script/common.js"></script>
    <script src="../../../js/jquery-1.8.3.min.js"></script>
    <script>
        $(function () {
            $.ajax({
                url: "../../../cust/losts",
                type: "get",
                success: function (obj) {
                    if (obj.code === 0) {
                        fillTable(obj.result);
                    } else {
                        alert("error");
                    }
                }
            });
        });

        function fillTable(param) {
            var table = $("#table");
            table.empty();
            var str = '<tr><th width="5%">编号</th>' +
                '<th width="20%">客户</th>' +
                '<th width="10%">客户经理</th>' +
                '<th width="20%">上次下单时间</th>' +
                '<th width="20%">确认流失时间</th>' +
                '<th width="15%">状态</th>' +
                '<th width="10%">操作</th></tr>';
            $.each(param.list, function (i, lost) {
                var lastOrder = '';
                if (lost.lst_last_order != null) {
                    lastOrder = formatDate(lost.lst_last_order);
                }
                var lostDate = '';
                if (lost.lst_date != null) {
                    lostDate = formatDate(lost.lst_date);
                }
                var status = '预警';
                if (lost.lst_status === 2) {
                    status = '暂缓流失';
                } else if (lost.lst_status === 3) {
                    status = '确认流失';
                }
                str += '<tr><td class="list_data_text">' + lost.lst_id + '</td>' +
                    '<td class="list_data_text">' + lost.lst_cust_name + '</td>' +
                    '<td class="list_data_text">' + lost.lst_manager_name + '</td>' +
                    '<td class="list_data_text">' + lastOrder + '</td>' +
                    '<td class="list_data_text">' + lostDate + '</td>' +
                    '<td class="list_data_text">' + status + '</td>' +
                    '<td class="list_data_op">' +
                    '<img onclick="toUrl(\'' + lost.lst_id + '\',\'confirm.html\');" title="确认流失" src="../../images/bt_confirm.gif" class="op_button"/>&nbsp;&nbsp;&nbsp;&nbsp;' +
                    '<img onclick="toUrl(\'' + lost.lst_id + '\',\'relay.html\');" title="暂缓流失" src="../../images/bt_relay.gif" class="op_button"/>' +
                    '</td></tr>';
            });
            str += "<tr><th colspan='7' class='pager'>" +
                "<div class='pager'>" +
                "共" + param.count + "条记录&nbsp;&nbsp;" +
                "每页<input type='number' id='pageSize' value='" + param.pageSize + "' style='width:40px''/>条&nbsp;&nbsp;" +
                "第" + param.pageNo + "页/共" + param.pageCount + "页&nbsp;&nbsp;" +
                "<a href='javascript:search(1)'>第一页</a>&nbsp;" +
                "<a href='javascript:search(" + (param.pageNo - 1) + ")'>上一页</a>&nbsp;&nbsp;" +
                "<a href='javascript:search(" + (param.pageNo + 1) + ")'>下一页</a>&nbsp;&nbsp;" +
                "<a href='javascript:search(" + param.pageCount + ")'>最后一页</a>&nbsp;&nbsp;" +
                "转到<input type='number' min='1' id='pageNo' value='" + param.pageNo + "' style='width:50px'/>页" +
                "<button onclick='go();'>GO</button>" +
                "</div></th></tr>";
            table.append(str);
        }

        function go() {
            var pageNo = $("#pageNo").val();
            search(pageNo);
        }

        function search(pageNo) {
            var pageSize = $("#pageSize").val();
            var status = $("#status").val();
            var data = "pageNo=" + pageNo + "&pageSize=" + pageSize + "&lst_status=" + status;
            var cust_name = $("#cust_name").val();
            if (cust_name !== "") {
                data += "&lst_cust_name=" + cust_name;
            }
            var manager_name = $("#manager_name").val();
            if (manager_name !== "") {
                data += "&lst_manager_name=" + manager_name;
            }
            $.ajax({
                url: "../../../cust/losts",
                type: "get",
                data: data,
                success: function (obj) {
                    if (obj.code === 0) {
                        fillTable(obj.result);
                    } else {
                        alert("error");
                    }
                }
            });
        }
    </script>
</head>
<body>
<div class="page_title">客户流失管理</div>
<div class="button_bar">
    <button class="common_button" onclick="help('');">帮助</button>
    <button class="common_button" onclick="search(1);">查询</button>
</div>
<table class="query_form_table">
    <tr>
        <th>客户</th>
        <td><input type="text" id="cust_name"/></td>
        <th>客户经理</th>
        <td><input type="text" id="manager_name"/></td>
        <th>状态</th>
        <td>
            <select id="status">
                <option value="0">全部</option>
                <option value="1">预警</option>
                <option value="2">暂缓流失</option>
                <option value="3">确认流失</option>
            </select>
        </td>
    </tr>
</table>
<br/>
<table class="data_list_table" id="table">
</table>
</body>
</html>