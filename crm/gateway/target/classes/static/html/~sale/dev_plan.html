<!DOCTYPE html>
<html lang="en">
<head>
    <title>客户开发计划 - 制定计划</title>
    <meta charset="UTF-8">
    <link href="../css/style.css" rel="stylesheet" type="text/css">
    <script src="../script/common.js"></script>
    <script src="../../calendar/WdatePicker.js"></script>
    <script src="../../js/jquery-1.8.3.min.js"></script>
    <script>
        $(function () {
            var id = localStorage.getItem("id");
            $.ajax({
                url: "../../marketing/salPlan/" + id,
                type: "get",
                success: function (obj) {
                    if (obj.code === 0) {
                        var chance = obj.result.chance;
                        $("#id").html(chance.chc_id);
                        $("#source").html(chance.chc_source);
                        $("#cust_name").html(chance.chc_cust_name);
                        $("#rate").html(chance.chc_rate);
                        $("#title").html(chance.chc_title);
                        $("#linkman").html(chance.chc_linkman);
                        $("#tel").html(chance.chc_tel);
                        $("#desc").html(chance.chc_desc);
                        $("#create_by").html(chance.chc_create_by);
                        $("#create_date").html(formatDate(chance.chc_create_date));
                        if (chance.chc_due_to != null) {
                            $("#due_to").html(chance.chc_due_to);
                            $("#due_date").html(formatDate(chance.chc_due_date));
                        }
                        $.each(obj.result.plans, function (i, plan) {
                            var str = "<tr id='plan_" + plan.pla_id + "'>" +
                                "<td class='list_data_text' height='24'>" + formatDate(plan.pla_date, 1) + "</td>" +
                                "<td class='list_data_ltext' height='24'>" +
                                "<input type='text' id='todo_" + plan.pla_id + "' size='100' value='" + plan.pla_todo + "'/>&nbsp;&nbsp;" +
                                "<button class='common_button' onclick='editSalPlan(" + plan.pla_id + ");'>保存</button>&nbsp;&nbsp;" +
                                "<button class='common_button' onclick='delSalPlan(" + plan.pla_id + ");'>删除</button>" +
                                "</td></tr>";
                            $("#table1").append(str);
                        });
                    } else {
                        alert(obj.msg);
                    }
                }
            });
        });

        function delSalPlan(id) {
            var flag = confirm("确定要删除吗？");
            if (flag) {
                $.ajax({
                    url: "../../marketing/salPlan/" + id,
                    type: "delete",
                    success: function (obj) {
                        if (obj.code === 0) {
                            alert("删除成功！");
                            $("#plan_" + id).remove();
                        } else {
                            alert(obj.msg);
                        }
                    }
                });
            }
        }

        function editSalPlan(id) {
            var todo = $("#todo_" + id).val();
            var data = '{pla_id:"' + id + '",pla_todo:"' + todo + '"}';
            $.ajax({
                url: "../../marketing/salPlan",
                type: "put",
                data: data,
                dataType: "json",
                contentType: "application/json;charset=utf-8",
                success: function (obj) {
                    if (obj.code === 0) {
                        alert("保存成功！");
                    } else {
                        alert(obj.msg);
                    }
                }
            });
        }

        function addSalPlan() {
            var id = $("#id").html();
            var todo = $("#newTodo").val();
            var date = $("#newDate").val();
            var data = '{pla_chc_id:"' + id + '",pla_date:"' + date + '",pla_todo:"' + todo + '"}';
            $.ajax({
                url: "../../marketing/salPlan",
                type: "post",
                data: data,
                dataType: "json",
                contentType: "application/json;charset=utf-8",
                success: function (obj) {
                    if (obj.code === 0) {
                        alert("新建计划成功！");
                        reload(true);
                    } else {
                        alert(obj.msg);
                    }
                }
            });
        }
    </script>
</head>
<body>
<div class="page_title">客户开发计划&nbsp;&nbsp;&gt;&nbsp;&nbsp;制定计划</div>
<div class="button_bar">
    <button class="common_button" onclick="help('制定计划');">帮助</button>
    <button class="common_button" onclick="to('dev_execute.html');">执行计划</button>
    <button class="common_button" onclick="back();">返回</button>
</div>
<table class="query_form_table">
    <tr>
        <th>编号</th>
        <td id="id"></td>
        <th>机会来源</th>
        <td id="source"></td>
    </tr>
    <tr>
        <th>客户名称</th>
        <td id="cust_name"></td>
        <th>成功机率（%）</th>
        <td id="rate"></td>
    </tr>
    <tr>
        <th>概要</th>
        <td colspan="3" id="title"></td>
    </tr>
    <tr>
        <th>联系人</th>
        <td id="linkman"></td>
        <th>联系人电话</th>
        <td id="tel"></td>
    </tr>
    <tr>
        <th>机会描述</th>
        <td colspan="3" id="desc"></td>
    </tr>
    <tr>
        <th>创建人</th>
        <td id="create_by"></td>
        <th>创建时间</th>
        <td id="create_date"></td>
    </tr>
    <tr>
        <th>指派给</th>
        <td id="due_to"></td>
        <th>指派时间</th>
        <td id="due_date"></td>
    </tr>
</table>
<br/>
<table class="data_list_table" id="table1">
    <tr>
        <th width="150px">日期</th>
        <th height="31">计划项</th>
    </tr>
</table>
<div class="button_bar">
    <button class="common_button" onclick="addSalPlan();">保存</button>
</div>
<table class="query_form_table" id="table2">
    <tr>
        <th>日期</th>
        <td><input type="text" id="newDate" readonly onclick="WdatePicker();"/><span class="red_star">*</span>
        </td>
        <th>计划项</th>
        <td><input type="text" size="50" id="newTodo"/><span class="red_star">*</span></td>
    </tr>
</table>
</body>
</html>